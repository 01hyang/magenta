#!/bin/bash

# Copyright 2016 The Fuchsia Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

readonly NM="$1"
readonly INPUT="$2"
readonly OUTPUT="$3"

# This extracts two symbol addresses from the $INPUT executable, and writes
# "#define ADDR_<symbol> 0x..." lines to the $OUTPUT header file.  This
# lets the assembly code implementing the dummy "dynamic linker" find the
# right places in the main program's address space, without having to
# implement anything nontrivial in the test code itself.

set -e

collect_addrs() {
  echo "/* This file is generated by $0. */
"

  local addr type name
  while read addr type name; do
    case "${name}" in
      _start|test_word) ;;
      *) continue ;;
    esac
    echo "#define ADDRESS_${name} 0x${addr}"
  done

echo "
/* End of generated file. */"
}

"${NM}" -g "${INPUT}" | collect_addrs > "${OUTPUT}"


exit 0
